import streamlit as st
import pandas as pd
import pdfplumber
import re
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# --- USTAWIENIA (MoÅ¼esz zmieniaÄ‡) ---
PROG_KWOTOWY = 1000.00
LIMIT_INTERWENCJI = 300.00

# --- FUNKCJE ---
def wyslij_maila(nazwa_pliku, kwota, brakuje, rekomendacja, email_nadawcy, haslo_nadawcy, email_odbiorcy):
    msg = MIMEMultipart()
    msg['From'] = email_nadawcy
    msg['To'] = email_odbiorcy
    msg['Subject'] = f"ğŸ”” OKAZJA: ZamÃ³wienie na {kwota} zÅ‚ - Brakuje {brakuje} zÅ‚!"
    
    body = f"""
    CzeÅ›Ä‡! PrzeanalizowaÅ‚em plik: {nazwa_pliku}
    
    ğŸ’° WartoÅ›Ä‡ zamÃ³wienia: {kwota} zÅ‚
    ğŸ“‰ Brakuje do progu (1000 zÅ‚): {brakuje} zÅ‚
    
    (RÃ³Å¼nica jest mniejsza niÅ¼ {LIMIT_INTERWENCJI} zÅ‚ - warto dzwoniÄ‡!)
    
    ğŸ’¡ REKOMENDACJA:
    {rekomendacja}
    """
    msg.attach(MIMEText(body, 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(email_nadawcy, haslo_nadawcy)
        server.sendmail(email_nadawcy, email_odbiorcy, msg.as_string())
        server.quit()
        return True
    except Exception as e:
        st.error(f"BÅ‚Ä…d wysyÅ‚ki maila: {e}")
        return False

def analizuj_pdf(uploaded_file):
    text = ""
    with pdfplumber.open(uploaded_file) as pdf:
        for page in pdf.pages:
            text += page.extract_text()
    return text

# --- UI APLIKACJI ---
st.set_page_config(page_title="GEKO Szybki Start", page_icon="âš¡")
st.title("âš¡ GEKO - Szybka Analiza")
st.write("WrzuÄ‡ fakturÄ™, a ja sprawdzÄ™, czy brakuje do 1000 zÅ‚.")

# Pobieranie haseÅ‚ (dla bezpieczeÅ„stwa)
try:
    EMAIL_NADAWCY = st.secrets["EMAIL_NADAWCY"]
    HASLO_NADAWCY = st.secrets["HASLO_NADAWCY"]
    EMAIL_ODBIORCY = st.secrets["EMAIL_ODBIORCY"]
except:
    EMAIL_NADAWCY = "" # Å»eby siÄ™ nie wywaliÅ‚o, jak nie ma haseÅ‚

uploaded_file = st.file_uploader("ğŸ“‚ WrzuÄ‡ plik PDF", type="pdf")

if uploaded_file:
    # 1. Czytamy plik
    text = analizuj_pdf(uploaded_file)
    
    # 2. Szukamy kwoty (szuka "Razem netto" lub najwiÄ™kszej kwoty w pliku)
    # To jest prosty mechanizm - szuka liczb z przecinkiem i bierze najwiÄ™kszÄ… jako sumÄ™
    kwoty = re.findall(r"(\d+[\.,]\d{2})\s?PLN", text)
    if not kwoty:
        # PrÃ³ba innego formatu (bez PLN)
        kwoty = re.findall(r"(\d+[\.,]\d{2})", text)
        
    if kwoty:
        # Zamieniamy przecinki na kropki i szukamy max
        wartosc_netto = max([float(k.replace(',', '.').replace(' ', '')) for k in kwoty])
    else:
        wartosc_netto = 0.0
        st.warning("Nie znalazÅ‚em kwoty automatycznie. SprawdÅº czy PDF jest czytelny.")

    # WyÅ›wietlamy wynik
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric("Znaleziona kwota netto", f"{wartosc_netto:.2f} zÅ‚")
    
    # 3. Logika 300 zÅ‚
    brakujaca = PROG_KWOTOWY - wartosc_netto
    
    with col2:
        if wartosc_netto >= PROG_KWOTOWY:
            st.success("âœ… PrÃ³g 1000 zÅ‚ osiÄ…gniÄ™ty! Klient ma gratis.")
        elif 0 < brakujaca <= LIMIT_INTERWENCJI:
            st.error("ğŸ”¥ ALARM! BRAKUJE MAÅO!")
            st.write(f"Do progu brakuje: **{brakujaca:.2f} zÅ‚**")
            st.write(f"(To mniej niÅ¼ {LIMIT_INTERWENCJI} zÅ‚)")
            
            rekomendacja = "DomÃ³w: OstrzaÅ‚ka do Å‚aÅ„cuchÃ³w (G81207) lub chemia warsztatowa."
            st.info(f"ğŸ’¡ PodpowiedÅº: {rekomendacja}")
            
            # Przycisk maila
            if st.button("ğŸ“§ WyÅ›lij mi powiadomienie"):
                if EMAIL_NADAWCY:
                    sukces = wyslij_maila(uploaded_file.name, f"{wartosc_netto:.2f}", f"{brakujaca:.2f}", rekomendacja, EMAIL_NADAWCY, HASLO_NADAWCY, EMAIL_ODBIORCY)
                    if sukces:
                        st.toast("Mail wysÅ‚any!", icon="ğŸš€")
                else:
                    st.error("Nie ustawiÅ‚eÅ› haseÅ‚ w 'Secrets'!")
                    
        elif brakujaca > LIMIT_INTERWENCJI:
            st.warning("Spokojnie.")
            st.write(f"Brakuje aÅ¼ **{brakujaca:.2f} zÅ‚**.")
            st.write("PowyÅ¼ej limitu 300 zÅ‚ -> Nie dzwonimy.")
        else:
            st.error("CoÅ› nie tak z kwotÄ… (0 zÅ‚?).")

    # PodglÄ…d tekstu (dla pewnoÅ›ci co widzi robot)
    with st.expander("ğŸ” Zobacz co widzÄ™ w PDF"):
        st.text(text)
