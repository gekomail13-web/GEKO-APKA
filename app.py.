import streamlit as st
import pandas as pd
import pdfplumber
import re
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# --- BAZA WIEDZY (MoÅ¼esz tu dopisywaÄ‡ nowe promocje) ---
PROMOCJE_WIELOSZTUKI = {
    "G80402": {"nazwa": "Nagrzewnica 5KW", "ilosc_prog": 2, "cena_szt": 186.47, "cena_promo": 164.76},
    "G80405": {"nazwa": "Nagrzewnica Cer. 2KW", "ilosc_prog": 2, "cena_szt": 71.47, "cena_promo": 56.78},
    "G80024": {"nazwa": "Prostownik CLASS 430", "ilosc_prog": 2, "cena_szt": 290.00, "cena_promo": 270.80},
    # Tu moÅ¼esz dopisywaÄ‡ kolejne kody...
}

PROG_KWOTOWY = 1000.00
NAGRODA_KWOTOWA = "Bluza Polarowa za 1 zÅ‚"
LIMIT_INTERWENCJI = 300.00  # Twoja zasada "300 zÅ‚"

# --- FUNKCJE ---
def wyslij_maila(klient, brakuje, rekomendacja, email_nadawcy, haslo_nadawcy, email_odbiorcy):
    msg = MIMEMultipart()
    msg['From'] = email_nadawcy
    msg['To'] = email_odbiorcy
    msg['Subject'] = f"ðŸ”” OKAZJA: {klient} - Brakuje {brakuje:.2f} zÅ‚!"
    
    body = f"""
    CzeÅ›Ä‡! Analiza zamÃ³wienia dla klienta: {klient}.
    
    ðŸ’° Brakuje do progu: {brakuje:.2f} zÅ‚
    (Jest to mniej niÅ¼ {LIMIT_INTERWENCJI} zÅ‚ - warto dzwoniÄ‡!)
    
    ðŸ’¡ REKOMENDACJA:
    {rekomendacja}
    """
    msg.attach(MIMEText(body, 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(email_nadawcy, haslo_nadawcy)
        server.sendmail(email_nadawcy, email_odbiorcy, msg.as_string())
        server.quit()
        return True
    except Exception as e:
        return False

def analizuj_pdf(uploaded_file):
    text = ""
    with pdfplumber.open(uploaded_file) as pdf:
        for page in pdf.pages:
            text += page.extract_text()
    return text

# --- INTERFEJS APLIKACJI ---
st.set_page_config(page_title="GEKO Asystent", page_icon="ðŸ”§")
st.title("ðŸ”§ GEKO Sales Booster")

# Konfiguracja (Pobierana z "wnÄ™trza" chmury dla bezpieczeÅ„stwa)
try:
    EMAIL_NADAWCY = st.secrets["EMAIL_NADAWCY"]
    HASLO_NADAWCY = st.secrets["HASLO_NADAWCY"]
    EMAIL_ODBIORCY = st.secrets["EMAIL_ODBIORCY"]
except:
    st.error("Brak konfiguracji haseÅ‚ w 'Secrets'! Aplikacja nie wyÅ›le maila.")
    EMAIL_NADAWCY = ""

uploaded_file = st.file_uploader("WrzuÄ‡ zamÃ³wienie (PDF)", type="pdf")

if uploaded_file:
    # 1. Analiza tekstu
    text = analizuj_pdf(uploaded_file)
    
    # PrÃ³ba znalezienia kwoty netto (prosty regex, szuka "Razem netto" itp.)
    # W prawdziwym Å¼yciu faktury sÄ… rÃ³Å¼ne, to uproszczona wersja:
    kwoty = re.findall(r"(\d+[\.,]\d{2})\s?PLN", text)
    if kwoty:
        # ZakÅ‚adamy Å¼e najwiÄ™ksza kwota to suma (uproszczenie)
        wartosc_netto = max([float(k.replace(',', '.')) for k in kwoty])
    else:
        wartosc_netto = st.number_input("Nie widzÄ™ kwoty automatycznie. Wpisz wartoÅ›Ä‡ netto:", value=0.0)

    # PrÃ³ba znalezienia klienta
    klient = "Nieznany Klient" 
    if "Nabywca" in text:
        parts = text.split("Nabywca")
        if len(parts) > 1:
            klient = parts[1].splitlines()[1][:50] # Bierze pierwszÄ… liniÄ™ pod "Nabywca"

    st.write(f"Klient: **{klient}**")
    st.write(f"WartoÅ›Ä‡: **{wartosc_netto} zÅ‚**")

    # 2. Logika "300 zÅ‚"
    brakujaca = PROG_KWOTOWY - wartosc_netto
    
    col1, col2 = st.columns(2)
    with col1:
        st.info("ðŸ“Š Status Promocji")
        if wartosc_netto >= PROG_KWOTOWY:
            st.success(f"âœ… PrÃ³g osiÄ…gniÄ™ty! Klient ma {NAGRODA_KWOTOWA}!")
        else:
            st.write(f"Brakuje do {PROG_KWOTOWY} zÅ‚: **{brakujaca:.2f} zÅ‚**")

    with col2:
        st.warning("ðŸ“ž Decyzja Handlowa")
        if 0 < brakujaca <= LIMIT_INTERWENCJI:
            rekomendacja = "DomÃ³w: OstrzaÅ‚ka do Å‚aÅ„cuchÃ³w (G81207) lub chemia warsztatowa."
            st.error("ðŸ”¥ DZWONIÄ†! MIEÅšCI SIÄ˜ W LIMICIE!")
            st.write(f"ðŸ‘‰ {rekomendacja}")
            
            if st.button("ðŸ“§ WyÅ›lij powiadomienie na telefon"):
                if wyslij_maila(klient, brakujaca, rekomendacja, EMAIL_NADAWCY, HASLO_NADAWCY, EMAIL_ODBIORCY):
                    st.toast("WysÅ‚ano!", icon="âœ…")
                else:
                    st.error("BÅ‚Ä…d wysyÅ‚ki.")
        elif brakujaca > LIMIT_INTERWENCJI:
            st.success("Spokojnie. Brakuje za duÅ¼o (>300zÅ‚). Nie dzwonimy.")
        else:
            st.write("Promocja juÅ¼ zdobyta.")
