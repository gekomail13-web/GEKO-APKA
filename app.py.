import streamlit as st
import pdfplumber
import re
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# ==========================================
# ‚öôÔ∏è KONFIGURACJA I BAZA WIEDZY (EDYCJA)
# ==========================================

# 1. PROGI KWOTOWE (Zasady z Gazetki Stycze≈Ñ)
PROG_KWOTOWY = 1000.00
NAGRODA_ZA_PROG = "Bluza Polarowa za 1 z≈Ç"
LIMIT_INTERWENCJI = 300.00  # Twoja z≈Çota zasada (nie dzwonimy powy≈ºej tej kwoty)

# 2. INTELIGENTNE REGU≈ÅY (Cross-selling)
# Je≈õli system znajdzie s≈Çowo KLUCZ w fakturze, zaproponuje PRODUKT.
INTELIGENTNE_REGULY = {
    "Prowadnica": {
        "produkt": "Ostrza≈Çka elektr. do ≈Ça≈Ñcuch√≥w (G81207)", 
        "cena": 79.29, 
        "opis": "Klient serwisuje pi≈Çy - ostrza≈Çka to pewniak."
    },
    "≈Åa≈Ñcuch": {
        "produkt": "Olej do smarowania ≈Ça≈Ñcuch√≥w (G82000)", 
        "cena": 19.99, 
        "opis": "Do ≈Ça≈Ñcucha zawsze potrzebny jest olej."
    },
    "Wykrƒôtaki": {
        "produkt": "Zestaw gwintownik√≥w i narzynek 32el (G38301)", 
        "cena": 50.89, 
        "opis": "Po wykrƒôcaniu zerwanych ≈õrub czƒôsto trzeba poprawiƒá gwint."
    },
    "Nagrzewnica": {
        "produkt": "Druga sztuka do pary (Rabat Wielosztuka!)", 
        "cena": 164.76, 
        "opis": "Sprawd≈∫ gazetkƒô '2026AB' - przy 2 sztukach cena spada!"
    },
    "Tarcza": {
        "produkt": "Rƒôkawice robocze Wampirki (Pakiet 10 par)", 
        "cena": 25.00, 
        "opis": "Tarcze i rƒôkawice to towary zu≈ºywalne - warto dom√≥wiƒá."
    },
    "Prostownik": {
        "produkt": "Kable rozruchowe 600A (G02400)",
        "cena": 35.50,
        "opis": "Zestaw zimowy: prostownik + kable."
    },
     "Siekiera": {
        "produkt": "Ostrza≈Çka do no≈ºy i siekier 2w1 (T02-009)",
        "cena": 15.00,
        "opis": "Ma≈Çe, tanie, a pasuje idealnie do siekiery."
    }
}

# Domy≈õlna propozycja, jak nic innego nie pasuje
DOMYSLNA_REKOMENDACJA = {
    "produkt": "Chemia warsztatowa / Zmywacze",
    "cena": 0,
    "opis": "Uniwersalny produkt, ≈ºeby dobiƒá do progu."
}

# ==========================================
# üîß FUNKCJE SYSTEMOWE
# ==========================================

def wyslij_maila(nazwa_pliku, dane, rekomendacja, email_nadawcy, haslo_nadawcy, email_odbiorcy):
    msg = MIMEMultipart()
    msg['From'] = email_nadawcy
    msg['To'] = email_odbiorcy
    msg['Subject'] = f"üîî OKAZJA: Brakuje {dane['brakuje']:.2f} z≈Ç! ({dane['klient']})"
    
    body = f"""
    Cze≈õƒá! Raport z Asystenta Sprzeda≈ºy GEKO.
    
    üìÑ Plik: {nazwa_pliku}
    üë§ Klient (NIP): {dane['nip']}
    
    üí∞ WARTO≈öƒÜ ZAM√ìWIENIA: {dane['netto']:.2f} z≈Ç
    üìâ BRAKUJE DO PROGU ({PROG_KWOTOWY} z≈Ç): {dane['brakuje']:.2f} z≈Ç
    
    üí° CO PROPONOWAƒÜ:
    üëâ Produkt: {rekomendacja['produkt']}
    üëâ Argument: {rekomendacja['opis']}
    
    Dzia≈Çaj!
    Tw√≥j Bot
    """
    msg.attach(MIMEText(body, 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(email_nadawcy, haslo_nadawcy)
        server.sendmail(email_nadawcy, email_odbiorcy, msg.as_string())
        server.quit()
        return True
    except Exception as e:
        st.error(f"B≈ÇƒÖd wysy≈Çki maila: {e}")
        return False

def analizuj_pdf(uploaded_file):
    text = ""
    with pdfplumber.open(uploaded_file) as pdf:
        for page in pdf.pages:
            text += page.extract_text()
    return text

def znajdz_kwote_i_nip(text):
    # 1. Szukanie kwoty (szuka format√≥w: 123,45 PLN lub 123.45)
    kwoty = re.findall(r"(\d+[\.,]\d{2})\s?PLN", text)
    if not kwoty:
        kwoty = re.findall(r"(\d+[\.,]\d{2})", text)
    
    wartosc_netto = 0.0
    if kwoty:
        # Zamiana przecink√≥w na kropki, usuwanie spacji
        wartosc_netto = max([float(k.replace(',', '.').replace(' ', '')) for k in kwoty])

    # 2. Szukanie NIP (ciƒÖg 10 cyfr, omijamy nasz w≈Çasny NIP)
    nipy = re.findall(r'\d{10}', text.replace('-', ''))
    moj_nip = "7722420459" # NIP GEKO
    klient_nip = "Brak NIP"
    
    for n in nipy:
        if n != moj_nip:
            klient_nip = n
            break
            
    # Pr√≥ba znalezienia nazwy klienta (bardzo uproszczona)
    klient_nazwa = "Nieznany Klient"
    if "Nabywca" in text:
        try:
            parts = text.split("Nabywca")
            klient_nazwa = parts[1].splitlines()[1][:30] + "..."
        except:
            pass

    return wartosc_netto, klient_nip, klient_nazwa

def dopasuj_rekomendacje(text):
    znalezione = []
    for slowo, regula in INTELIGENTNE_REGULY.items():
        if slowo.lower() in text.lower(): # Wielko≈õƒá liter nie ma znaczenia
            znalezione.append(regula)
    
    if znalezione:
        return znalezione[0] # Zwraca pierwszƒÖ pasujƒÖcƒÖ
    else:
        return DOMYSLNA_REKOMENDACJA

# ==========================================
# üì± INTERFEJS APLIKACJI (STREAMLIT)
# ==========================================

st.set_page_config(page_title="GEKO Asystent PRO", page_icon="üöÄ", layout="centered")

# Pobieranie hase≈Ç z Secrets (ukryte przed ≈õwiatem)
try:
    EMAIL_NADAWCY = st.secrets["EMAIL_NADAWCY"]
    HASLO_NADAWCY = st.secrets["HASLO_NADAWCY"]
    EMAIL_ODBIORCY = st.secrets["EMAIL_ODBIORCY"]
except:
    st.warning("‚ö†Ô∏è Brak konfiguracji hase≈Ç! Aplikacja nie wy≈õle maila.")
    EMAIL_NADAWCY = None

# Nag≈Ç√≥wek
st.title("üöÄ GEKO Sales Booster")
st.markdown("Twoja tajna bro≈Ñ do faktur i promocji.")
st.markdown("---")

# Wgrywanie pliku
uploaded_file = st.file_uploader("üì∏ Wrzuƒá PDF z zam√≥wieniem", type="pdf")

if uploaded_file:
    with st.spinner("Analizujƒô fakturƒô... üïµÔ∏è‚Äç‚ôÇÔ∏è"):
        text = analizuj_pdf(uploaded_file)
        netto, nip, nazwa = znajdz_kwote_i_nip(text)
        rekomendacja = dopasuj_rekomendacje(text)
        brakujaca = PROG_KWOTOWY - netto

    # Wy≈õwietlanie wynik√≥w
    col1, col2 = st.columns(2)
    with col1:
        st.info("üìã Dane zam√≥wienia")
        st.write(f"**Klient:** {nazwa}")
        st.write(f"**NIP:** {nip}")
        st.metric("Kwota Netto", f"{netto:.2f} z≈Ç")
    
    with col2:
        st.info("üìä Status Promocji")
        st.write(f"Cel: **{PROG_KWOTOWY} z≈Ç** ({NAGRODA_ZA_PROG})")
        if netto >= PROG_KWOTOWY:
            st.success("‚úÖ ZROBIONE! Pr√≥g osiƒÖgniƒôty.")
        else:
            st.warning(f"Brakuje: **{brakujaca:.2f} z≈Ç**")

    st.markdown("---")

    # LOGIKA DECYZYJNA
    if netto >= PROG_KWOTOWY:
        st.balloons()
        st.success("üéâ Klient ma ju≈º gratis. Nic nie musisz robiƒá.")

    elif brakujaca > LIMIT_INTERWENCJI:
        st.warning(f"‚õî R√≥≈ºnica jest zbyt du≈ºa (> {LIMIT_INTERWENCJI} z≈Ç).")
        st.write("Szkoda czasu na telefon. Odpuszczamy.")

    elif 0 < brakujaca <= LIMIT_INTERWENCJI:
        st.error("üî• ALARM! OKAZJA DO UPSELLINGU!")
        st.markdown(f"### Brakuje tylko: {brakujaca:.2f} z≈Ç")
        
        # Sekcja rekomendacji
        st.success("üí° MOJA SUGESTIA:")
        st.markdown(f"**Proponuj:** {rekomendacja['produkt']}")
        st.markdown(f"**Dlaczego:** *{rekomendacja['opis']}*")
        if rekomendacja['cena'] > 0:
            st.markdown(f"**Cena:** ok. {rekomendacja['cena']} z≈Ç")

        # Przycisk akcji
        st.markdown("---")
        if st.button("üìß Wy≈õlij mi raport na maila"):
            if EMAIL_NADAWCY:
                dane_do_maila = {"netto": netto, "brakuje": brakujaca, "nip": nip, "klient": nazwa}
                sukces = wyslij_maila(uploaded_file.name, dane_do_maila, rekomendacja, EMAIL_NADAWCY, HASLO_NADAWCY, EMAIL_ODBIORCY)
                if sukces:
                    st.toast("Mail wys≈Çany! Sprawd≈∫ telefon.", icon="üì®")
                else:
                    st.error("Wysy≈Çka nieudana. Sprawd≈∫ has≈Ça.")
            else:
                st.error("Nie skonfigurowa≈Çe≈õ hase≈Ç w Secrets!")
