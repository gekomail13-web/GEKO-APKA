import streamlit as st
import pandas as pd
import pdfplumber
import re
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# --- USTAWIENIA ---
PROG_KWOTOWY = 1000.00
LIMIT_INTERWENCJI = 300.00

# --- FUNKCJE ---
@st.cache_data
def load_clients():
    try:
        # Czytamy plik CSV. Separator to ≈õrednik (standard w polskim Excelu)
        df = pd.read_csv("baza_klientow.csv", sep=";", dtype={'NIP': str})
        return df
    except FileNotFoundError:
        return None

def wyslij_maila(klient_info, brakuje, rekomendacja, email_nadawcy, haslo_nadawcy, email_odbiorcy):
    msg = MIMEMultipart()
    msg['From'] = email_nadawcy
    msg['To'] = email_odbiorcy
    msg['Subject'] = f"üîî OKAZJA: {klient_info['Nazwa']} - Brakuje {brakuje:.2f} z≈Ç!"
    
    tel_link = f"tel:{klient_info['Telefon']}" if klient_info['Telefon'] else "#"
    
    body = f"""
    Cze≈õƒá! Analiza zam√≥wienia.
    
    üë§ Klient: {klient_info['Nazwa']} (NIP: {klient_info['NIP']})
    üìû Telefon: {klient_info['Telefon']}
    
    üí∞ Brakuje do progu: {brakuje:.2f} z≈Ç
    (Jest to mniej ni≈º {LIMIT_INTERWENCJI} z≈Ç)
    
    üí° REKOMENDACJA:
    {rekomendacja}
    """
    msg.attach(MIMEText(body, 'plain'))
    
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(email_nadawcy, haslo_nadawcy)
        server.sendmail(email_nadawcy, email_odbiorcy, msg.as_string())
        server.quit()
        return True
    except Exception as e:
        return False

def analizuj_pdf_i_szukaj_nipu(uploaded_file):
    text = ""
    with pdfplumber.open(uploaded_file) as pdf:
        for page in pdf.pages:
            text += page.extract_text()
            
    # Szukamy NIPu (10 cyfr)
    znalezione_nipy = re.findall(r'\d{10}', text.replace('-', ''))
    moj_nip = "7722420459" # NIP GEKO - ≈ºeby go ignorowaƒá
    klient_nip = None
    for n in znalezione_nipy:
        if n != moj_nip:
            klient_nip = n
            break
    return text, klient_nip

# --- UI APLIKACJI ---
st.set_page_config(page_title="GEKO Sales", page_icon="üìà")
st.title("üìà GEKO Sales Booster")

df_klienci = load_clients()
if df_klienci is None:
    st.warning("‚ö†Ô∏è Wgraj plik baza_klientow.csv na GitHub!")

try:
    EMAIL_NADAWCY = st.secrets["EMAIL_NADAWCY"]
    HASLO_NADAWCY = st.secrets["HASLO_NADAWCY"]
    EMAIL_ODBIORCY = st.secrets["EMAIL_ODBIORCY"]
except:
    st.error("Skonfiguruj has≈Ça w Secrets!")
    EMAIL_NADAWCY = ""

uploaded_file = st.file_uploader("Wrzuƒá PDF z zam√≥wieniem", type="pdf")

if uploaded_file:
    text, nip_z_faktury = analizuj_pdf_i_szukaj_nipu(uploaded_file)
    
    klient_info = {"Nazwa": "Nieznany", "NIP": nip_z_faktury, "Telefon": "Brak"}
    
    if nip_z_faktury and df_klienci is not None:
        znaleziony = df_klienci[df_klienci['NIP'] == nip_z_faktury]
        if not znaleziony.empty:
            klient_info["Nazwa"] = znaleziony.iloc[0]['Nazwa_Skrocona']
            klient_info["Telefon"] = str(znaleziony.iloc[0]['Telefon'])
            st.success(f"Klient: **{klient_info['Nazwa']}**")
        else:
            st.warning(f"NIP {nip_z_faktury} nieznany w bazie.")
    
    # Szukanie kwoty (proste)
    kwoty = re.findall(r"(\d+[\.,]\d{2})\s?PLN", text)
    wartosc_netto = max([float(k.replace(',', '.')) for k in kwoty]) if kwoty else 0.0
    
    st.metric("Warto≈õƒá zam√≥wienia", f"{wartosc_netto} z≈Ç")

    brakujaca = PROG_KWOTOWY - wartosc_netto
    
    if 0 < brakujaca <= LIMIT_INTERWENCJI:
        rekomendacja = "Dom√≥w: Ostrza≈Çka do ≈Ça≈Ñcuch√≥w (G81207)"
        st.error(f"üî• Okazja! Brakuje tylko {brakujaca:.2f} z≈Ç")
        
        if klient_info['Telefon'] != "Brak":
            st.markdown(f"### üìû [ZADZWO≈É TERAZ: {klient_info['Telefon']}](tel:{klient_info['Telefon']})")
        
        if st.button("üìß Wy≈õlij raport na maila"):
            if wyslij_maila(klient_info, brakujaca, rekomendacja, EMAIL_NADAWCY, HASLO_NADAWCY, EMAIL_ODBIORCY):
                st.toast("Wys≈Çano!", icon="‚úÖ")
    elif brakujaca > LIMIT_INTERWENCJI:
        st.info("Za du≈ºo brakuje (>300z≈Ç). Odpuszczamy.")
    else:
        st.success("Promocja ju≈º zdobyta!")